
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê³¨í”„ ë¨¸ë‹ˆ ê³„ì‚°ê¸° â€“ ìµœì¢…ë³¸ (ìŠ¤í‚¨ êµ¬ê°„ ìƒ‰ ìˆ˜ì • v2 + ì´ íŒŒ/ì´ íƒ€ìˆ˜)</title>
<style>
body { font-family: Arial, sans-serif; margin: 16px; }
table { border-collapse: collapse; width: 100%; max-width: 100%; }
th, td { border: 1px solid #999; padding: 6px; text-align: center; }
input { width: 64px; text-align:center; box-sizing: border-box; }
.name-input { width: 120px; }
.controls { margin-bottom: 10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.move { font-weight: bold; }
.note { font-size:12px; color:#555; margin-top:4px; }
.pos { color: #0a7; font-weight: bold; }
.neg { color: #d33; font-weight: bold; }
/* ë²„ë”” / ì´ê¸€ ìƒ‰ìƒ */
.birdie { background:#cfefff; }
.eagle  { background:#ffe3b3; }
/* ìŠ¤í‚¨ ë”´ êµ¬ê°„ í•˜ì´ë¼ì´íŠ¸ (ì´ë²ˆì— ë°›ì€ ìŠ¤í‚¨ í™€ êµ¬ê°„ë§Œ) */
.skinwin { background: #c08dff !important; color:#000; }
/* ë²„íŠ¼ */
button { padding: 6px 12px; cursor: pointer; }
</style>
</head>
<body>

<h2>ê³¨í”„ ë¨¸ë‹ˆ ê³„ì‚°ê¸° (ìµœì¢…ë³¸ â€“ ìŠ¤í‚¨ êµ¬ê°„ ìƒ‰ v2 + ì´ íŒŒ/ì´ íƒ€ìˆ˜)</h2>

<div class="controls">
  í”Œë ˆì´ì–´ ìˆ˜:
  <select id="playerCount" onchange="setupPlayers()">
    <option value="2">2ëª…</option>
    <option value="3">3ëª…</option>
    <option value="4" selected>4ëª…</option>
    <option value="5">5ëª…</option>
  </select>

  ê¸°ë³¸ íƒ€ë‹¹($): <input id="rate" value="2" oninput="calculateGame()">
  ë²„ë””($): <input id="birdie" value="5" oninput="calculateGame()">
  ì´ê¸€($): <input id="eagle" value="20" oninput="calculateGame()">
  ìŠ¤í‚¨($): <input id="skin" value="2" oninput="calculateGame()">

  ìŠ¤í‚¨ ë°°íŒ:
  <select id="skinCarryOn" onchange="resetSkinCarry()">
    <option value="1" selected>ON</option>
    <option value="0">OFF</option>
  </select>

  ìŠ¤í‚¨ ìµœëŒ€í™€:
  <input id="skinMaxPayout" value="3" oninput="calculateGame()">

  <button onclick="captureScreen()">ğŸ“¸ ì „ì²´í™”ë©´ ìŠ¤í¬ë¦°ìƒ·</button>
</div>

<div class="note">
- íƒ€ë‹¹ ë°°íŒ: ì „ í™€ì—ì„œ <b>ë²„ë”” ì´ìƒ / íŠ¸ë¦¬í”Œ ì´ìƒ / ì „ì› ê°™ì€ ìŠ¤ì½”ì–´</b>ë©´, ë‹¤ìŒ í™€ íƒ€ë‹¹ì´ 2ë°°ê°€ ë©ë‹ˆë‹¤.<br>
- ìŠ¤í‚¨ ìµœëŒ€í™€: ìŠ¤í‚¨ ì´ì›”ì´ í•œ ë²ˆì— í„°ì§ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ í™€ ìˆ˜ (ì˜ˆ: 3ì´ë©´, 4í™€ ì´ì›” ì‹œ 3í™€ë§Œ ì§€ê¸‰ + 1í™€ì€ ë‹¤ì‹œ ì´ì›”).<br>
- ë²„ë””(íŒŒ-1)ëŠ” í•˜ëŠ˜ìƒ‰, ì´ê¸€(íŒŒ-2 ì´í•˜)ëŠ” ì£¼í™©ìƒ‰ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.<br>
- ìŠ¤í‚¨ì„ ë¨¹ì€ ì‚¬ëŒì€, <b>ì´ë²ˆì— ì‹¤ì œë¡œ ë°›ì€ ìŠ¤í‚¨ ê°œìˆ˜ë§Œí¼ ë°”ë¡œ ì§ì „ í™€ê¹Œì§€</b> ìì‹ ì˜ ê¸ˆì•¡ ì¹¸ì´ ì§„í•œ ë³´ë¼ìƒ‰ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.<br>
  ì˜ˆ) 1,2,3í™€ ì´ì›” í›„ 3ë²ˆí™€ì—ì„œ ìŠ¤í‚¨ 3ê°œ ë¨¹ìœ¼ë©´ 1~3ë²ˆí™€, 4,5í™€ ì´ì›” í›„ 6ë²ˆí™€ì—ì„œ ìŠ¤í‚¨ 3ê°œ ë¨¹ìœ¼ë©´ 4~6ë²ˆí™€ í‘œì‹œ.
</div>

<br>
<div id="nameArea"></div>
<br>

<table id="scoreTable"></table>

<h3>18í™€ ëˆ„ì  ë¨¸ë‹ˆ ê²°ê³¼</h3>
<div id="totalResult"></div>

<h3>ì´ íŒŒ / ê° í”Œë ˆì´ì–´ ì´ íƒ€ìˆ˜</h3>
<div id="strokeResult"></div>

<script>
let players = 4;
let skinCarryCount = 0;

function setupPlayers() {
  players = parseInt(document.getElementById("playerCount").value);

  let nameHTML = "";
  for (let i = 0; i < players; i++) {
    nameHTML += `Player ${i+1} ì´ë¦„: <input class="name-input" id="name${i}" value="Player ${i+1}" oninput="updateHeader()"> `;
  }
  document.getElementById("nameArea").innerHTML = nameHTML;

  buildTable();
  resetSkinCarry();
  calculateGame();
}

function resetSkinCarry(){
  skinCarryCount = 0;
  calculateGame();
}

function updateHeader(){
  buildTable(true);
  calculateGame();
}

function buildTable(keepScore=false) {
  const oldScores = {};
  if(keepScore){
    for(let h=1;h<=18;h++){
      for(let i=0;i<players;i++){
        const el = document.getElementById(`s${h}_${i}`);
        if(el) oldScores[`s${h}_${i}`] = el.value;
      }
    }
  }

  const tbl = document.getElementById("scoreTable");
  tbl.innerHTML = "";

  let header = "<tr><th rowspan='2'>í™€</th><th rowspan='2'>íŒŒ</th>";
  for (let i=0;i<players;i++){
    const nm = document.getElementById("name"+i)?.value || ("Player "+(i+1));
    header += `<th colspan='2'>${nm}</th>`;
  }
  header += "<th rowspan='2'>ì´ í™€ ì´ ì´ë™</th></tr>";

  header += "<tr>";
  for (let i=0;i<players;i++){
    header += "<th>íƒ€ìˆ˜</th><th>ê¸ˆì•¡</th>";
  }
  header += "</tr>";

  tbl.innerHTML += header;

  for (let h=1;h<=18;h++) {
    let row = `<tr><td>${h}</td><td><input id="par${h}" value="4" oninput="calculateGame()"></td>`;
    for (let i=0;i<players;i++) {
      row += `<td><input id="s${h}_${i}" oninput="calculateGame()"></td>`;
      row += `<td class="move" id="pm${h}_${i}">$0</td>`;
    }
    row += `<td class="move" id="move${h}">$0</td></tr>`;
    tbl.innerHTML += row;
  }

  if(keepScore){
    for(let key in oldScores){
      const el=document.getElementById(key);
      if(el) el.value=oldScores[key];
    }
  }
}

function clearSkinHighlights(){
  for(let h=1; h<=18; h++){
    for(let i=0; i<players; i++){
      const cell = document.getElementById(`pm${h}_${i}`);
      if(cell) cell.classList.remove("skinwin");
    }
  }
}

function calculateGame() {
  if (!document.getElementById("rate")) return;

  let baseRate = Number(document.getElementById("rate").value) || 0;
  let birdie = Number(document.getElementById("birdie").value) || 0;
  let eagle = Number(document.getElementById("eagle").value) || 0;
  let skin = Number(document.getElementById("skin").value) || 0;
  let carryOn = document.getElementById("skinCarryOn").value === "1";
  let maxPayout = Math.max(1, Number(document.getElementById("skinMaxPayout").value || 1));

  let totalMoney = new Array(players).fill(0);
  let totalStrokes = new Array(players).fill(0);
  let totalPar = 0;

  skinCarryCount = 0;
  clearSkinHighlights();

  let nextRateMult = 1;

  for (let h=1;h<=18;h++) {
    const rateMult = nextRateMult;
    const holeRate = baseRate * rateMult;

    let par = Number(document.getElementById("par"+h).value) || 0;
    if (par > 0) totalPar += par;

    let scores = [];

    for (let i=0;i<players;i++) {
      let input = document.getElementById(`s${h}_${i}`);
      if (!input) continue;
      let val = Number(input.value || 0);
      scores.push(val);
      if (val > 0) totalStrokes[i] += val;

      input.classList.remove("birdie","eagle");
      if(par > 0){
        if(val === par-1) input.classList.add("birdie");
        if(val <= par-2 && val > 0) input.classList.add("eagle");
      }
    }
    if (scores.length < players) continue;

    let holeMoney = new Array(players).fill(0);

    // 1) íƒ€ìˆ˜ ì°¨ì´
    for (let i=0;i<players;i++) {
      for (let j=i+1;j<players;j++) {
        const diff = scores[i] - scores[j];
        if (diff > 0) {
          holeMoney[i] -= diff * holeRate;
          holeMoney[j] += diff * holeRate;
        } else if (diff < 0) {
          holeMoney[i] += Math.abs(diff) * holeRate;
          holeMoney[j] -= Math.abs(diff) * holeRate;
        }
      }
    }

    // 2) ë²„ë”” / ì´ê¸€
    if (par > 0){
      scores.forEach((s, i) => {
        if (s > 0 && s <= par - 2) { // ì´ê¸€ ì´ìƒ
          holeMoney[i] += eagle * (players - 1);
          for (let j=0;j<players;j++) if (j!==i) holeMoney[j] -= eagle;
        } else if (s === par - 1) { // ë²„ë””
          holeMoney[i] += birdie * (players - 1);
          for (let j=0;j<players;j++) if (j!==i) holeMoney[j] -= birdie;
        }
      });
    }

    // 3) ìŠ¤í‚¨
    let didSkinPay = false;
    let skinWinnerIdx = -1;
    let payableHoles = 0; // ì´ë²ˆì— ì‹¤ì œë¡œ ë°›ì€ ìŠ¤í‚¨ ê°œìˆ˜

    if (par > 0){
      const positiveScores = scores.filter(x=>x>0);
      if (positiveScores.length === players){
        const min = Math.min(...positiveScores);
        const winCount = scores.filter(v => v === min).length;

        if (winCount === 1 && min <= par) {
          const winnerIdx = scores.indexOf(min);
          skinWinnerIdx = winnerIdx;

          if (carryOn) {
            const totalSkins = skinCarryCount + 1;
            const payable = Math.min(totalSkins, maxPayout);
            const remain = Math.max(0, totalSkins - maxPayout);
            if(payable > 0){
              holeMoney[winnerIdx] += skin * (players - 1) * payable;
              for (let j=0;j<players;j++) if (j!==winnerIdx) holeMoney[j] -= skin * payable;
              didSkinPay = true;
              payableHoles = payable;
            }
            skinCarryCount = remain;
          } else {
            holeMoney[winnerIdx] += skin * (players - 1);
            for (let j=0;j<players;j++) if (j!==winnerIdx) holeMoney[j] -= skin;
            didSkinPay = true;
            payableHoles = 1;
            skinCarryCount = 0;
          }
        } else {
          if (carryOn) skinCarryCount += 1;
        }
      }
    }

    // 4) ê¸ˆì•¡ ë°˜ì˜
    let moveSum = 0;
    for (let i=0;i<players;i++){
      const cell = document.getElementById(`pm${h}_${i}`);
      if (!cell) continue;
      const money = holeMoney[i];
      cell.innerText = (money>=0?"+":"") + "$" + money.toFixed(0);
      cell.className = "move " + (money>=0 ? "pos" : "neg");
      moveSum += Math.abs(money);
      totalMoney[i] += money;
    }

    const moveCell = document.getElementById("move"+h);
    if (moveCell) moveCell.innerText = "$" + (moveSum/2).toFixed(0);

    // âœ… ìŠ¤í‚¨ ìƒ‰: ì´ë²ˆì— ë°›ì€ ìŠ¤í‚¨ ê°œìˆ˜(payableHoles)ë§Œí¼, ë°”ë¡œ ìœ„ í™€ë¶€í„° ìƒ‰ì¹ 
    if(didSkinPay && skinWinnerIdx >= 0 && payableHoles > 0){
      const startHole = Math.max(1, h - payableHoles + 1);
      for(let hh = startHole; hh <= h; hh++){
        const c = document.getElementById(`pm${hh}_${skinWinnerIdx}`);
        if(c) c.classList.add("skinwin");
      }
    }

    // 5) ë‹¤ìŒ í™€ íƒ€ë‹¹ ë°°íŒ ì—¬ë¶€
    let nextMult = 1;
    if (par > 0){
      const positiveScores2 = scores.filter(x=>x>0);
      if (positiveScores2.length === players){
        let hasBirdieOrBetter = scores.some(s => s>0 && s <= par-1);
        let hasTripleOrWorse = scores.some(s => s >= par+3);
        let allEqual = scores.every(s => s === scores[0] && s>0);
        if (hasBirdieOrBetter || hasTripleOrWorse || allEqual) {
          nextMult = 2;
        }
      }
    }
    nextRateMult = nextMult;
  }

  // 18í™€ ë¨¸ë‹ˆ ê²°ê³¼
  let resultHTML = "";
  for (let i=0;i<players;i++) {
    const nm = document.getElementById("name"+i)?.value || ("Player "+(i+1));
    resultHTML += nm + ": $" + totalMoney[i].toFixed(0) + "<br>";
  }
  document.getElementById("totalResult").innerHTML = resultHTML;

  // ì´ íŒŒ / ì´ íƒ€ìˆ˜
  let strokeHTML = "ì´ íŒŒ: " + totalPar + "<br>";
  for (let i=0;i<players;i++){
    const nm = document.getElementById("name"+i)?.value || ("Player "+(i+1));
    strokeHTML += nm + " ì´ íƒ€ìˆ˜: " + totalStrokes[i] + "<br>";
  }
  document.getElementById("strokeResult").innerHTML = strokeHTML;
}

async function captureScreen(){
  try{
    const stream = await navigator.mediaDevices.getDisplayMedia({ video: { frameRate: 30 } });
    const track = stream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);
    const bitmap = await imageCapture.grabFrame();

    const canvas = document.createElement("canvas");
    canvas.width = bitmap.width;
    canvas.height = bitmap.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(bitmap, 0, 0);

    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = "golf_score_screenshot.png";
    link.click();
    track.stop();
  } catch(e){
    alert("ìŠ¤í¬ë¦°ìƒ·ì„ ì‚¬ìš©í•˜ë ¤ë©´ í™”ë©´ ê³µìœ  ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.");
  }
}

setupPlayers();
</script>

</body>
</html>
